@using SixMan.ChiMa.Domain.Base
@using SixMan.ChiMa.Web.Startup
@using SixMan.ChiMa.Application.Food.Dto
@model SixMan.ChiMa.Web.Models.PagedResultVM<FoodMaterialDto>
@{
    ViewBag.CurrentPageName = PageNames.FoodMaterial; //The menu item will be active for this page.
}


<div id="toolbar" class="btn-group">
    <button id="btn_add" type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
    </button>
    <button id="btn_edit" type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
    </button>
    <button id="btn_delete" type="button" class="btn btn-default">
        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
    </button>
</div>

<table id="tb_dept" data-bind="myBootstrapTable:$root">
    <thead>
        <tr>
            <th data-checkbox="true"></th>
            <th data-field="description">菜品名称</th>
            <th data-field="season">季节</th>
        </tr>
    </thead>
</table>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">操作</h4>
            </div>
            <div class="modal-body">

                <div class="form-group">
                    <label for="txt_description">菜品名称</label>
                    <input type="text" name="txt_description" data-bind="value:description" class="form-control" id="txt_description" placeholder="菜品名称">
                </div>
                <div class="form-group">
                    <label for="txt_season">季节</label>
                    <input type="text" name="txt_season" data-bind="value:season" class="form-control" id="txt_season" placeholder="季节">
                </div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                <button type="button" id="btn_submit" class="btn btn-primary" data-dismiss="modal"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>保存</button>
            </div>
        </div>
    </div>
</div>

@section scripts
{
<script>
    //初始化
    $(function () {
        //0, 设置service
        ko.appService = abp.services.app.foodMaterial;
        //1、初始化表格
        tableInit.Init();
        //2、注册增删改事件
        operate.operateInit();
    });

    //初始化表格
    var tableInit = {
        Init: function () {
            //绑定table的viewmodel
            this.myViewModel = new ko.bootstrapTableViewModel({
                url: '/api/services/app/FoodMaterial/GetAll',         //请求后台的URL（*）
                method: 'get',                      //请求方式（*）
                toolbar: '#toolbar',                //工具按钮用哪个容器
            });
            ko.applyBindings(this.myViewModel, document.getElementById("tb_dept"));
        }
    };

    //操作
    var operate = {
        //初始化按钮事件
        operateInit: function () {
            this.operateAdd();
            this.operateUpdate();
            this.operateDelete();
            this.DepartmentModel = {
                id: ko.observable(),
                description: ko.observable(),
                season: ko.observable()
            };
        },
        //新增
        operateAdd: function () {
            $('#btn_add').on("click", function () {
                $("#myModal").modal().on("shown.bs.modal", function () {
                    var oEmptyModel = {
                        id: ko.observable(),
                        description: ko.observable(),
                        season: ko.observable()
                    };
                    ko.utils.extend(operate.DepartmentModel, oEmptyModel);
                    ko.applyBindings(operate.DepartmentModel, document.getElementById("myModal"));
                    operate.operateSave();
                }).on('hidden.bs.modal', function () {
                    ko.cleanNode(document.getElementById("myModal"));
                });
            });
        },
        //编辑
        operateUpdate: function () {
            $('#btn_edit').on("click", function () {
                $("#myModal").modal().on("shown.bs.modal", function () {
                    var arrselectedData = tableInit.myViewModel.getSelections();
                    if (!operate.operateCheck(arrselectedData)) { return; }
                    //将选中该行数据有数据Model通过Mapping组件转换为viewmodel
                    ko.utils.extend(operate.DepartmentModel, ko.mapping.fromJS(arrselectedData[0]));
                    ko.applyBindings(operate.DepartmentModel, document.getElementById("myModal"));
                    operate.operateSave();
                }).on('hidden.bs.modal', function () {
                    //关闭弹出框的时候清除绑定(这个清空包括清空绑定和清空注册事件)
                    ko.cleanNode(document.getElementById("myModal"));
                });
            });
        },
        //删除
        operateDelete: function () {
            $('#btn_delete').on("click", function () {
                var arrselectedData = tableInit.myViewModel.getSelections();
                //var data = JSON.stringify(arrselectedData);
                var idsData = arrselectedData.map(function (item) {
                    return item.id;
                }).join(",");
                var oDataModel = ko.toJS(arrselectedData);
                abp.message.confirm(
                    "Delete foodMaterial '" + "'?",
                    function (isConfirmed) {
                        if (isConfirmed) {
                            ko.appService.deleteList({
                                ids: idsData
                            }
                            ).done(function () {
                                tableInit.myViewModel.refresh();
                            });
                        }
                    }
                );
                // $.ajax({
                //     url: "/FoodMaterial/Delete",
                //     type: "post",
                //     contentType: 'application/json',
                //     data: JSON.stringify(arrselectedData),
                //     success: function (data, status) {
                //         //alert(status);
                //         tableInit.myViewModel.refresh();
                //     }
                // });
            });
        },
        //保存数据
        operateSave: function () {
            $('#btn_submit').on("click", function () {
                //取到当前的viewmodel
                var oViewModel = operate.DepartmentModel;
                //将Viewmodel转换为数据model
                var oDataModel = ko.toJS(oViewModel);
                var funcName = oDataModel.id ? "Update" : "Add";

                if (funcName === "Add") {
                    ko.appService.create(oDataModel).done(function (res) {
                        alert(JSON.stringify(res));
                        tableInit.myViewModel.refresh();
                    });
                }
                else {
                    ko.appService.update(oDataModel).done(function (res) {
                        alert(JSON.stringify(res));
                        tableInit.myViewModel.refresh();
                    });
                }

            });
        },
        //数据校验
        operateCheck: function (arr) {
            if (arr.length <= 0) {
                alert("请至少选择一行数据");
                return false;
            }
            if (arr.length > 1) {
                alert("只能编辑一行数据");
                return false;
            }
            return true;
        }
    }

</script> 

}